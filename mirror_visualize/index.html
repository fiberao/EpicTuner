<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<style type="text/css">
    body { margin: 0; overflow: hidden; }
    #mygraph {
      position: absolute;
      width: 100%;
      height: 100%;
    }
</style>
  <title>Deformable Mirror Visualization</title>
  <script type="text/javascript" src="static/vis.js"></script>
  <script type="text/javascript" src="static/reconnecting-websocket.min.js"></script>
</head>

<body onresize="graph.redraw();" >
<div id="mygraph"></div>
<script type="text/javascript">
	var graph = null;
	var data = new vis.DataSet();
	data.add({x:1,y:1,z:1});
    
    var options = {
        width:  "100%",
        height:  "100%",
        style: 'surface',
        showPerspective: true,
        showGrid: true,
        showShadow: false,
        xMax:45,
		xMin:0,
		yMax:45,
		yMin:0,
		zMax:45,
		zMin:0,
        keepAspectRatio: true,
        verticalRatio: 0.2
      };
      var container = document.getElementById('mygraph');
      graph = new vis.Graph3d(container, data, options);

function tl_mirror_map(input){
	var hexmap_x=25;
	var hexmap_y=25;
	var data = new vis.DataSet();
	var test=[];
	for (var x=-hexmap_x;x<=hexmap_x;x++){
		for (var y=-hexmap_y;y<=hexmap_y;y++){
			var r=Math.sqrt(x*x+y*y);
			r=r/hexmap_x;
			var theta=Math.atan2(y, x)  / (2.0*Math.PI)+0.5;
			var ring=0;
			if (Math.floor(r*10)<9) {
				 ring=24+Math.ceil(theta*16);
			}
			if (Math.floor(r*10)<6) {
				 ring=8+Math.ceil(theta*16);
			}
			if (Math.floor(r*10)<3){
				 ring=0+Math.ceil(theta*8);
			}
			if (ring>40 || ring<0){
				//console.log(ring)
			}
			test[(x+hexmap_x)+(y+hexmap_y)*(hexmap_x*2)]=input[ring];
			//data.add({x:x+hexmap_x,y:y+hexmap_y,z:input[ring]})
		}
	}
	var smooth_l=4;
    for (var x=0;x<2*hexmap_x;x++) 
        for (var y=0;y<2*hexmap_y;y++) {
        		var sum=0;
        		for (var sx=0;sx<smooth_l;sx++) 
        			for (var sy=0;sy<smooth_l;sy++) 
        				sum+=test[(y+sy)*(hexmap_x*2)+x+sx];
        		sum/=smooth_l*smooth_l;
        		
        		if (sum<=45)
        			data.add({x:x,y:y,z:sum})
    }
    return data;
}
      function oko_mirror_map(input) {
	  	var data = new vis.DataSet();
	  	var hexmap_x=9;
	  	var hexmap_y=9;
        var hexmap_orig = [
        			0, 0, 0, 0, 0, 0, 0, 0,0,
        			0, 0,23,24,25,26, 0, 0,0,
                    0, 0,22,10,11,12,27, 0,0,
        			0,21,09,03,04,13,28, 0,0,
                    0,20,08,02,01,05,14,29,0,
        			0,37,19,07,06,15,30, 0,0,
                    0, 0,36,18,17,16,31, 0,0,
        			0, 0,35,34,33,32, 0, 0,0,
        			0, 0, 0, 0, 0, 0, 0, 0,0,
        ];
        var hexmap=[];
        for (var i=0; i<hexmap_x*hexmap_y; i++){
            hexmap.push(input[hexmap_orig[i]])
        }
        var test=[];
       
        for (var y=0;y<hexmap_y;y++){
           var length =6;
        	var line =[];
        	//padding
        	if (y%2==1)
        		for (var l=0;l<length/2;l++) 
        			line.push(input[0]);
        	for (var x=0;x<hexmap_x;x++)
        		for (var l=0;l<length;l++) 
        			line.push(hexmap[y*hexmap_x+x]);
        	//padding
        	if (y%2==0)
        		for (var l=0;l<length/2;l++) 
        			line.push(input[0]);
        	// expand line
        	for (var l=0;l<length;l++)
        		for (var i=0;i<hexmap_x*length;i++) 
        			test.push(line[i]);
        }
        var smooth_l=6;
        for (var x=0;x<length*hexmap_x;x++) 
        	for (var y=0;y<length*hexmap_y;y++) {
        		var sum=0;
        		for (var sx=0;sx<smooth_l;sx++) 
        			for (var sy=0;sy<smooth_l;sy++) 
        				sum+=test[(y+sy)*(hexmap_x*length)+x+sx];
        		sum/=smooth_l*smooth_l;
        		
        		if (sum<=45)
        			data.add({x:x,y:y,z:sum})
        }
        return data;
    }
      //websocket
    var ws = new ReconnectingWebSocket("ws://127.0.0.1:5678/");
    ws.onmessage = function (event) {
    	var ret=JSON.parse(event.data);
		//graph.setData(oko_mirror_map(ret));
		if (ret.length<40){
			ret.push(30,30,30);
		}
		graph.setData(tl_mirror_map(ret));
    };
    ws.onclose=function(event){
    	var data = new vis.DataSet();
    	data.add({x:1,y:1,z:1});
    	graph.setData(data);
    }
</script>
</body>
</html>

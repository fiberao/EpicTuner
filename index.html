<!doctype html>
<html lang="en">
<head>
<title>MMDM Visualization</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<style>
    body { margin: 0; overflow: hidden; }
</style>
</head>
<body>
<div id="webgl"></div>
<script src="./static/lib/three.min.js"></script>
<script src="./static/lib/TrackballControls.js"></script> 
<script>

    var width  = window.innerWidth,
        height = window.innerHeight;

    var scene = new THREE.Scene();

    var axes = new THREE.AxisHelper(200);
    scene.add(axes);

    var camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
    camera.position.y = -200;
    camera.position.z = 100;

    var renderer = new THREE.WebGLRenderer();
    renderer.setSize(width, height);
    //renderer.shadowMapEnabled = true;
    //renderer.shadowMapSoft = true;
    document.getElementById('webgl').appendChild(renderer.domElement);



        var geometry = new THREE.PlaneGeometry(200, 200, 199, 199);
		geometry.dynamic = true;

        geometry.computeFaceNormals();
        geometry.computeVertexNormals();

        var material = new THREE.MeshPhongMaterial({
            color: 0xdddddd, 
            wireframe: true
        });

        var plane = new THREE.Mesh(geometry, material);
        plane.castShadow = true;
        plane.receiveShadow = true;
        scene.add(plane);

        var controls = new THREE.TrackballControls(camera); 

       

        scene.add(new THREE.AmbientLight(0x111111));

        var light = new THREE.DirectionalLight(0xffffff, 1);
        light.shadowCameraVisible = true;
        light.position.set(0,300,100);
        scene.add(light);
        var bad =true;
        var input=[];
	    var ws = new WebSocket("ws://127.0.0.1:5678/");
            ws.onmessage = function (event) {
                bad=true;
                input=eval(event.data);
                //console.log(input.toString());
            };
        render();
		
        function render() {
        	if (bad){
        		bad=false;
        		loadTerrain(input,function (data){
			        for (var i = 0, l = geometry.vertices.length; i < l; i++) {
			            geometry.vertices[i].z = data[i];
			        }
				});
				geometry.verticesNeedUpdate=true;
        	}
        		
            controls.update();    
            requestAnimationFrame(render);
            renderer.render(scene, camera);
        }


    //https://github.com/mrdoob/three.js/blob/master/src/loaders/XHRLoader.js

    // https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/Sending_and_Receiving_Binary_Data
    
    function loadTerrain(input,callback) {
        /*var req = new XMLHttpRequest();
        req.responseType = 'arraybuffer';
        req.open('GET', file, true);
        req.onload = function(evt) {
            if (req.response) {
                callback(new Uint16Array(req.response));
            }
        };
        req.send(null);*/
        var hexmap_orig = [
        			0, 0, 0, 0, 0, 0, 0, 0,0,
        			0, 0,23,24,25,26, 0, 0,0,
                    0, 0,22,10,11,12,27, 0,0,
        			0,21,09,03,04,13,28, 0,0,
                    0,20,08,02,01,05,14,29,0,
        			0,37,19,07,06,15,30, 0,0,
                    0, 0,36,18,17,16,31, 0,0,
        			0, 0,35,34,33,32, 0, 0,0,
        			0, 0, 0, 0, 0, 0, 0, 0,0,
        			];
        var hexmap=[];
        for (var i=0; i<9*9; i++){
            hexmap.push(input[hexmap_orig[i]])
        }
        var test=[];
        var length =20;
        for (var y=0;y<9;y++){
        	var line =[];
        	//padding
        	if (y%2==1)
        		for (var l=0;l<length/2;l++) line.push(input[0]);
        	for (var x=0;x<9;x++)
        		for (var l=0;l<length;l++) line.push(hexmap[y*9+x]);
        	//padding
        	if (y%2==0)
        		for (var l=0;l<length/2;l++) line.push(input[0]);
        	// expand line
        	for (var l=0;l<length;l++)
        		for (var i=0;i<200;i++) 
        			test.push(line[i]);
        } 
        callback(test);
    }

</script>
</body>
</html>